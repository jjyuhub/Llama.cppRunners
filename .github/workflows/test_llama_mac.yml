name: Build and Test llama.cpp on macOS

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build-and-test:
    runs-on: macos-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Clone llama.cpp repository
      run: |
        git clone https://github.com/ggml-org/llama.cpp.git
        cd llama.cpp
        git submodule update --init --recursive

    - name: Set up environment
      run: |
        brew update
        brew install cmake gcc wget libomp

    - name: Download model file
      run: |
        mkdir -p llama.cpp/models/deepseek-r1-distill
        cd llama.cpp/models/deepseek-r1-distill
        wget -O DeepSeek-R1-Distill-Qwen-1.5B-Q4_K_M.gguf "https://huggingface.co/unsloth/DeepSeek-R1-Distill-Qwen-1.5B-GGUF/resolve/main/DeepSeek-R1-Distill-Qwen-1.5B-Q4_K_M.gguf"

    - name: Build llama.cpp
      run: |
        cd llama.cpp
        mkdir -p build && cd build
        cmake ..
        cmake --build . --parallel $(sysctl -n hw.ncpu)
        ls -la bin

    - name: Verify if llama-run is built
      run: |
        if [ -f "llama.cpp/build/bin/llama-run" ]; then
          echo "llama-run is built successfully."
        else
          echo "llama-run not found. Build might have failed."
          exit 1
        fi

    - name: Run llama with test prompt
      run: |
        cd llama.cpp/build
        if [ -f "./bin/llama-run" ]; then
          ./bin/llama-run file://$HOME/llama.cpp/models/deepseek-r1-distill/DeepSeek-R1-Distill-Qwen-1.5B-Q4_K_M.gguf "How is llama.cpp?"
        else
          echo "llama-run not found. Skipping test."
          exit 1
        fi
